<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CitizenController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">participationSystem0</a> &gt; <a href="index.source.html" class="el_package">hello.controllers</a> &gt; <span class="el_source">CitizenController.java</span></div><h1>CitizenController.java</h1><pre class="source lang-java linenums">package hello.controllers;

import hello.domain.Categoria;
import hello.domain.Citizen;
import hello.domain.Configuration;
import hello.domain.Sugerencia;
import hello.services.*;
import hello.util.exception.CitizenException;
import org.apache.commons.codec.digest.DigestUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;

import javax.servlet.http.HttpSession;
import java.util.List;

/**
 * Created by pelay on 28/03/2017.
 */
@Controller
@Scope(&quot;session&quot;)
<span class="nc" id="L26">public class CitizenController {</span>

	/*
	 * private KafkaProducer kafkaProducer; private Citizen citizen;
	 */
<span class="nc" id="L31">	private String idCat = &quot;all&quot;;</span>

	private CitizenService citizenService;
	private SuggestionService suggestionService;
	private CategoryService categoryService;
	private CommentService commentService;
	private SystemServices systemService;

	@Autowired
	public void setCommentService(CommentService commentService) {
<span class="nc" id="L41">		this.commentService = commentService;</span>
<span class="nc" id="L42">	}</span>

	@Autowired
	public void setCategoryService(CategoryService categoryService) {
<span class="nc" id="L46">		this.categoryService = categoryService;</span>
<span class="nc" id="L47">	}</span>

	@Autowired
	public void setCitizenService(CitizenService citizenService) {
<span class="nc" id="L51">		this.citizenService = citizenService;</span>
<span class="nc" id="L52">	}</span>

	@Autowired
	public void setSuggestionService(SuggestionService suggestionService) {
<span class="nc" id="L56">		this.suggestionService = suggestionService;</span>
<span class="nc" id="L57">	}</span>

	@Autowired
	public void setSystemService(SystemServices systemService) {
<span class="nc" id="L61">		this.systemService = systemService;</span>
<span class="nc" id="L62">	}</span>
	/*
	 * @RequestMapping(&quot;/&quot;) public String landing(Model model) { //
	 * model.addAttribute(&quot;message&quot;, new Message()); return &quot;index&quot;; }
	 */

	@RequestMapping(value = &quot;/home&quot;, method = RequestMethod.POST)
	public String getLogin(@RequestParam String email, @RequestParam String password, HttpSession session,
			Model model) {

<span class="nc" id="L72">		Citizen citizen = citizenService.getCitizen(email);</span>

<span class="nc bnc" id="L74" title="All 4 branches missed.">		if (citizen != null &amp;&amp; DigestUtils.sha512Hex(password).equals(citizen.getContrasena())) {</span>
<span class="nc" id="L75">			session.setAttribute(&quot;citizen&quot;, citizen);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">			if(!citizen.isAdmin()) {</span>
<span class="nc" id="L77">				List&lt;Sugerencia&gt; listaSugerencias = getSugerencias(null);</span>
<span class="nc" id="L78">				session.setAttribute(&quot;listaSugerencias&quot;, listaSugerencias);</span>
<span class="nc" id="L79">				session.setAttribute(&quot;listaCategorias&quot;, categoryService.findAll());</span>

<span class="nc" id="L81">				return &quot;/user/index&quot;;</span>
			}

			else{
<span class="nc" id="L85">				Configuration configuration = systemService.getConfiguration();</span>
<span class="nc" id="L86">				model.addAttribute(&quot;listaPalabras&quot;,configuration.getPalabrasNoPermitidas());</span>
<span class="nc" id="L87">				List&lt;Sugerencia&gt; listaSugerencias = suggestionService.findSugerenciaWithMinVotes();</span>
<span class="nc" id="L88">				session.setAttribute(&quot;listaSugerencias&quot;, listaSugerencias);</span>


<span class="nc" id="L91">				return &quot;/admin/adminIndex&quot;;</span>
			}
		}
<span class="nc" id="L94">		model.addAttribute(&quot;error&quot;, &quot;Your username and password is invalid.&quot;);</span>
<span class="nc" id="L95">		return &quot;index&quot;;</span>

	}

	@RequestMapping(value = &quot;/cat&quot;)
	public String getSugerenciasCat(@RequestParam String idCat, HttpSession session, Model model) {
<span class="nc" id="L101">		this.idCat = idCat;</span>
<span class="nc" id="L102">		putSugerenciasInSession(session);</span>

<span class="nc" id="L104">		return &quot;/user/index&quot;;</span>
	}

	private void putSugerenciasInSession(HttpSession session) {
<span class="nc bnc" id="L108" title="All 2 branches missed.">		if (&quot;all&quot;.equals(idCat)) {</span>
<span class="nc" id="L109">			session.setAttribute(&quot;listaSugerencias&quot;, suggestionService.findAll());</span>
		} else {
<span class="nc" id="L111">			Long id = Long.parseLong(idCat);</span>
<span class="nc" id="L112">			Categoria cat = categoryService.findById(id);</span>
<span class="nc" id="L113">			session.setAttribute(&quot;listaSugerencias&quot;, suggestionService.findByCat(cat));</span>

		}
<span class="nc" id="L116">	}</span>

	/*
	 * @RequestMapping(&quot;/send&quot;) public String send(Model model, @ModelAttribute
	 * Message message) { kafkaProducer.send(&quot;exampleTopic&quot;,
	 * message.getMessage()); return &quot;redirect:/&quot;; }
	 */

	@RequestMapping(value = &quot;/vote+&quot;, method = RequestMethod.POST)
	public String votePos(@RequestParam String idSug, HttpSession session) {

<span class="nc" id="L127">		Long id = Long.parseLong(idSug);</span>
<span class="nc" id="L128">		Sugerencia sugerencia = suggestionService.findById(id);</span>
<span class="nc" id="L129">		Citizen citizen = (Citizen) session.getAttribute(&quot;citizen&quot;);</span>
		try {
<span class="nc" id="L131">			suggestionService.votePositiveSugerencia(sugerencia, citizen);</span>
<span class="nc" id="L132">		} catch (CitizenException e) {</span>

<span class="nc" id="L134">		}</span>
<span class="nc" id="L135">		putSugerenciasInSession(session);</span>

<span class="nc" id="L137">		return &quot;/user/index&quot;;</span>
	}

	@RequestMapping(value = &quot;/vote-&quot;, method = RequestMethod.POST)
	public String voteNeg(@RequestParam String idSug, HttpSession session) {

<span class="nc" id="L143">		Long id = Long.parseLong(idSug);</span>
<span class="nc" id="L144">		Sugerencia sugerencia = suggestionService.findById(id);</span>
<span class="nc" id="L145">		Citizen citizen = (Citizen) session.getAttribute(&quot;citizen&quot;);</span>
		try {
<span class="nc" id="L147">			suggestionService.voteNegativeSugerencia(sugerencia, citizen);</span>
<span class="nc" id="L148">		} catch (CitizenException e) {</span>

<span class="nc" id="L150">		}</span>
<span class="nc" id="L151">		putSugerenciasInSession(session);</span>

<span class="nc" id="L153">		return &quot;/user/index&quot;;</span>
	}

	@RequestMapping(value = &quot;/sug&quot;)
	public String viewSug(@RequestParam String idSug, Model model) {
<span class="nc" id="L158">		Long id = Long.parseLong(idSug);</span>
<span class="nc" id="L159">		Sugerencia sugerencia = suggestionService.findById(id);</span>
<span class="nc" id="L160">		model.addAttribute(&quot;sugerencia&quot;, sugerencia);</span>
<span class="nc" id="L161">		return &quot;/user/viewSuggestion&quot;;</span>

	}

	@RequestMapping(value = &quot;/comment&quot;)
	public String addComment(@RequestParam String idSug, String comentario, Model model, HttpSession session) {
<span class="nc" id="L167">		Long id = Long.parseLong(idSug);</span>
<span class="nc" id="L168">		Sugerencia sugerencia = suggestionService.findById(id);</span>
<span class="nc" id="L169">		Citizen citizen = (Citizen) session.getAttribute(&quot;citizen&quot;);</span>
<span class="nc" id="L170">		commentService.createComentario(comentario, sugerencia, citizen);</span>
<span class="nc" id="L171">		sugerencia = suggestionService.findById(id);</span>
<span class="nc" id="L172">		model.addAttribute(&quot;sugerencia&quot;, sugerencia);</span>
<span class="nc" id="L173">		return &quot;/user/viewSuggestion&quot;;</span>
	}

	@RequestMapping(value = &quot;/createSuggestion&quot;)
	public String addComment(Model model) {
<span class="nc" id="L178">		model.addAttribute(&quot;listaCategorias&quot;, categoryService.findAll());</span>

<span class="nc" id="L180">		return &quot;/user/createSuggestion&quot;;</span>
	}

	 @RequestMapping(value = &quot;/submitSuggestion&quot;)
	 	 public String addSuggestion(@RequestParam String tituloSugerencia, @RequestParam String idCategoria, @RequestParam String contSugerencia, HttpSession session, Model model){
<span class="nc" id="L185">		 Citizen citizen = (Citizen) session.getAttribute(&quot;citizen&quot;);</span>
<span class="nc" id="L186">		 Long idCat = Long.parseLong(idCategoria);</span>
<span class="nc" id="L187">		 Categoria categoria = categoryService.findById(idCat);</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">		 if(systemService.contienePalabrasNoAdmitidas(tituloSugerencia) ||</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">		 systemService.contienePalabrasNoAdmitidas(contSugerencia)){</span>
<span class="nc" id="L190">					model.addAttribute(&quot;errorMessage&quot;,&quot;Contiene palabras no admitidas&quot;);</span>
<span class="nc" id="L191">			 		return &quot;/user/createSuggestion&quot;;</span>
		 }


		 try {
<span class="nc" id="L196">			 suggestionService.createSugerencia(citizen, categoria, tituloSugerencia, contSugerencia);</span>
<span class="nc" id="L197">		 } catch (CitizenException e) {</span>
<span class="nc" id="L198">			 e.printStackTrace();</span>
<span class="nc" id="L199">		 }</span>

<span class="nc" id="L201">		 List&lt;Sugerencia&gt; listaSugerencias = getSugerencias(null);</span>
<span class="nc" id="L202">		 session.setAttribute(&quot;listaSugerencias&quot;, listaSugerencias);</span>
<span class="nc" id="L203">		return &quot;/user/index&quot;;</span>
	 }

	private List&lt;Sugerencia&gt; getSugerencias(Categoria c) {
<span class="nc bnc" id="L207" title="All 2 branches missed.">		if (c == null) {</span>

<span class="nc" id="L209">			return suggestionService.findAll();</span>
		} else {
<span class="nc" id="L211">			return suggestionService.findByCat(c);</span>
		}
	}

	@RequestMapping(value = &quot;/logOut&quot;)
	public String logOut(HttpSession session){
<span class="nc" id="L217">	 	 	session.setAttribute(&quot;citizen&quot;,null);</span>
<span class="nc" id="L218">		return &quot;/index&quot;;</span>

	}



}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>